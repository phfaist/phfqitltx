
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{phfqit}[2016/01/28 phfqit package]

\RequirePackage{etoolbox}

\RequirePackage{amsmath}
\RequirePackage{dsfont}

\RequirePackage{mathrsfs}

\RequirePackage{mathtools}

% ------------------------------------------------
% Simple Symbols & Shorthands
% ------------------------------------------------

% 
% Some Symbols
% 
\newcommand{\Hs}{\mathscr{H}} % Hilbert space

\newcommand\bit[1]{\texttt{#1}} % bit values, formatted possibly differently.

\newcommand{\Ident}{\mathds{1}}

% identity process
\def\IdentProc[#1][#2]#3{\operatorname{id}_{#1\notblank{#2}{\to #2}{}}\notblank{#3}{\left(#3\right)}{}}

% Lie Groups & Algebras
\def\uu(#1){\phfqit@fmtLieAlgebra{u}(#1)}
\def\UU(#1){\phfqit@fmtGroup{U}(#1)}
\def\su(#1){\phfqit@fmtLieAlgebra{su}(#1)}
\def\SU(#1){\phfqit@fmtGroup{SU}(#1)}
\def\so(#1){\phfqit@fmtLieAlgebra{so}(#1)}
\def\SO(#1){\phfqit@fmtGroup{SO}(#1)}

\def\SN(#1){\mathrm{S}_{#1}}

\def\phfqit@fmtLieAlgebra#1{\mathrm{#1}}
\def\phfqit@fmtGroup#1{\mathrm{#1}}


% some shortcuts for partial derivatives
\newcommand{\xdd}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\dd}[1]{\frac{\partial}{\partial #1}}

\def\ee^#1{e^{#1}} % we could imagine that in inlines, we replace this by exp()...

%
% Gates
%
\newcommand{\gate}[1]{\ifmmode\textsc{\lowercase{#1}}\else{\rmfamily\textsc{\lowercase{#1}}}\fi}
\newcommand{\AND}{\gate{And}}
\newcommand{\XOR}{\gate{Xor}}
\newcommand{\CNOT}{\gate{C-Not}}
\newcommand{\NOT}{\gate{Not}}
\newcommand{\NOOP}{\gate{No-Op}}


% ------------------------------------------------
% Math Operators
% ------------------------------------------------

\DeclareMathOperator{\tr}{tr}
\DeclareMathOperator{\supp}{supp}
\DeclareMathOperator{\rank}{rank}
\DeclareMathOperator{\Span}{span} % \span is already defined by latex
\DeclareMathOperator{\spec}{spec}
\DeclareMathOperator{\diag}{diag}
\let\phfqit@Re\Re
\DeclareMathOperator{\phfqit@Realpart}{Re}%
\renewcommand{\Re}{\phfqit@Realpart}
\let\phfqit@Im\Im
\DeclareMathOperator{\phfqit@Imagpart}{Im}%
\renewcommand{\Im}{\phfqit@Imagpart}




% ------------------------------------------------
% Bras, Kets, Norms, more delimiter stuff
% ------------------------------------------------

\DeclarePairedDelimiterX\ket[1]{\lvert}{\rangle}{{#1}}

\DeclarePairedDelimiterX\bra[1]{\langle}{\rvert}{{#1}}

\DeclarePairedDelimiterX\braket[2]{\langle}{\rangle}{%
  {#1}\hspace{0.2ex}\delimsize\vert\hspace{0.2ex}{#2}%
}

\DeclarePairedDelimiterX\ketbra[2]{\lvert}{\rvert}{%
  {#1}\delimsize\rangle\hspace{-0.25ex}\delimsize\langle{#2}%
}

\DeclarePairedDelimiterX\proj[1]{\lvert}{\rvert}{%
  {#1}\delimsize\rangle\hspace{-0.25ex}\delimsize\langle{#1}%
}

\DeclarePairedDelimiterX\matrixel[3]{\langle}{\rangle}{%
  {#1}\hspace{0.2ex}\delimsize\vert\hspace{0.2ex}{#2}\hspace{0.2ex}\delimsize\vert\hspace{0.2ex}{#3}%
}

\DeclarePairedDelimiterX\dmatrixel[2]{\langle}{\rangle}{%
  {#1}\hspace{0.2ex}\delimsize\vert\hspace{0.2ex}{#2}\hspace{0.2ex}\delimsize\vert\hspace{0.2ex}{#1}%
}

\DeclarePairedDelimiterX\innerprod[2]{\langle}{\rangle}{%
  {#1},\hspace{0.2ex}{#2}%
}

\DeclarePairedDelimiterX\abs[1]{\lvert}{\rvert}{{#1}}

\DeclarePairedDelimiterX\avg[1]{\langle}{\rangle}{{#1}}

\DeclarePairedDelimiterX\norm[1]{\lVert}{\rVert}{{#1}}


% ------------------------------------------------
% Open/Closed/Semi-Open Intervals
% ------------------------------------------------

%[
\DeclarePairedDelimiterX\intervalc[2]{[}{]}{{#1\mathclose{}\,,\,\mathopen{}#2}}
\DeclarePairedDelimiterX\intervalo[2]{]}{[}{{#1\mathclose{}\,,\,\mathopen{}#2}}
\DeclarePairedDelimiterX\intervalco[2]{[}{[}{{#1\mathclose{}\,,\,\mathopen{}#2}}
\DeclarePairedDelimiterX\intervaloc[2]{]}{]}{{#1\mathclose{}\,,\,\mathopen{}#2}}
%]

% ------------------------------------------------
% Entropies
% ------------------------------------------------

\newcommand\HHSym{H}

%
% \@HHbase@inner{content}  -->  produces (content)
% \@HHbase@inner*{content}  -->  produces \left(content\right)
% \@HHbase@inner[\big]{content}  -->  produces \bigl(content\bigr)
%
\DeclarePairedDelimiterX\@HHbase@inner[1]{(}{)}{#1}

%
% \@HHbase  base macro for relative entropy macros.
%
% USAGE:
%
%   \@HHbase{H-symbol}{subscript}{superscript}<size-spec>[state][epsilon]{target system}[conditioning system]
%
% with optional <size-spec> =  "`*"  or  "`\Big"
% 
% Examples:
%
% \@HHbase{H-symbol}{subscript}{superscript}[\rho][\epsilon]{E}[X']
% \@HHbase{H-symbol}{subscript}{superscript}`*[\rho][\epsilon]{E}[X']     -> with \left( \right)
% \@HHbase{H-symbol}{subscript}{superscript}`\big[\rho][\epsilon]{E}[X']  -> with \bigl( \bigr)
%
%
\def\@HHbase#1#2{%
  #1_{#2}%
  \@HHbase@parsesize%
}
\robustify\@HHbase

\def\@HHbase@parsesize{%
  \begingroup\mathcode`\`="0060\relax%
  \gdef\HH@tmp@sizearg{}%
  \@ifnextchar`\@HHbase@withsize\@HHbase@endgroupandparseinner%
}

\def\@HHbase@withsize`#1{%
  \def\@tmp@arg{#1}%
  \def\@tmp@star{*}%
  \ifx\@tmp@arg\@tmp@star\relax%
    \gdef\HH@tmp@sizearg{*}%
    \expandafter\@HHbase@endgroupandparseinner%
  \else%
    \gdef\HH@tmp@sizearg{[#1]}%
    \expandafter\@HHbase@endgroupandparseinner%
  \fi%
}
\def\@HHbase@endgroupandparseinner{\endgroup\@HHbase@parseinner}

\newcommand\@HHbase@parseinner[1][]{%  arg: state
  \def\HH@tmpstore@state{#1}%
  \@HHbase@parseinner@%
}
\newcommand\@HHbase@parseinner@[2][]{% arg: epsilon and target system
  \def\HH@tmpstore@epsilon{#1}%
  \def\HH@tmpstore@system{#2}%
  \@HHbase@parseinner@@%
}
\newcommand\@HHbase@parseinner@@[1][]{% arg: conditioning system
  \def\HH@tmpstore@condsys{#1}%
  \@HHbase@do@inner%
}


\newtoks\HH@tmp@toks
\def\HH@addtoks#1\@HH@END@ADD@TOKS{\HH@tmp@toks=\expandafter{\the\HH@tmp@toks#1}}%

\def\@HHbase@do@inner{%
  %
  % Add the superscript
  %
  ^{\HH@tmpstore@epsilon}%
  % 
  % if system is blank, we just want the symbol itself with no argument.
  % 
  \expandafter\notblank\expandafter{\HH@tmpstore@system}{%
    % 
    % Construct the parenthetic argument to the entropy
    % 
    \HH@tmp@toks={}%
    %
    % ... add system:
    % 
    \expandafter\HH@addtoks\HH@tmpstore@system\@HH@END@ADD@TOKS%
    %
    % ... add conditional system, if specified:
    %
    \expandafter\notblank\expandafter{\HH@tmpstore@condsys}{%
      \HH@addtoks\mathclose{}\,\delimsize\vert\,\mathopen{}\@HH@END@ADD@TOKS%
      \expandafter\HH@addtoks\HH@tmpstore@condsys\@HH@END@ADD@TOKS%
    }{}%
    % 
    % tokens ready now. Prepare argument to command, and go.
    %
    \edef\tmp@args{\expandonce{\HH@tmp@sizearg}{\the\HH@tmp@toks}}%
    \expandafter\@HHbase@inner\tmp@args%
    % 
    _{\HH@tmpstore@state}% the state as subscript, if any
    %
  }{}%
  %
}




% 
% Entropy commands.
%
% Usage: \HH[state][epsilon]{target system}[conditioning system]
%        \HH`*[state][epsilon]{target system}[conditioning system]     -> within \left(...\right)
%        \HH`\big[state][epsilon]{target system}[conditioning system]  -> within \bigl(...\bigr)
% 
\newcommand\HH{\@HHbase{\HHSym}{}}
\newcommand\Hzero{\@HHbase{\HHSym}{\mathrm{max},0}}
\newcommand\Hmin{\@HHbase{\HHSym}{\mathrm{min}}}
\newcommand\Hmaxf{\@HHbase{\HHSym}{\mathrm{max}}}

%
% Entropy function:
%
%  \Hfunc(x)
%  \Hfunc`*(x)
%  \Hfunc`\big(x)
%
\def\Hfunc{%
  \begingroup\mathcode`\`="0060\relax%
  \gdef\Hfunc@tmp@sizearg{}%
  \@ifnextchar`\Hfunc@withsize\Hfunc@next%
}
\def\Hfunc@withsize`#1{%
  \def\@tmp@arg{#1}%
  \def\@tmp@star{*}%
  \ifx\@tmp@arg\@tmp@star\relax%
    \gdef\Hfunc@tmp@sizearg{*}%
    \endgroup%
    \expandafter\Hfunc@inner%
  \else%
    \gdef\Hfunc@tmp@sizearg{[#1]}%
    \endgroup%
    \expandafter\Hfunc@inner%
  \fi%
}
\def\Hfunc@next{\endgroup\Hfunc@inner}
\def\Hfunc@inner(#1){%
  \HHSym%  ({#1})%
  \expandafter\@HHbase@inner\Hfunc@tmp@sizearg{#1}%
}



% ------------------------------------------------
% Relative Entropies
% ------------------------------------------------


\newcommand\DDSym{D}


%
% \@DDbase@inner{rho}{Gamma}  -->  produces (\rho||\Gamma)
% \@DDbase@inner*{rho}{Gamma}  -->  produces \left(\rho||\Gamma\right)
% \@DDbase@inner[\big]{rho}{Gamma}  -->  produces \bigl(\rho||\Gamma\bigr)
%
\DeclarePairedDelimiterX\@DDbase@inner[2]{(}{)}{%
  #1\mathclose{}\,\delimsize\Vert\,\mathopen{}#2%
}

%
% \@DDbase  base macro for relative entropy macros.
%
% USAGE:
%
%   \@DDbase{D-symbol}{subscript}{superscript}<states-spec>
%
% with  <states-spec> =     {\rho}{\sigma}
%                       or  `*{\rho}{\sigma}
%                       or  `\big{\rho}{\sigma}
%                       or  *{\rho}{\sigma}
%                       or  [\big]{\rho}{\sigma}
% 
% Examples:
%
% \@DDbase{D-symbol}{subscript}{superscript}{\rho}{\Gamma}
% \@DDbase{D-symbol}{subscript}{superscript}*{\rho}{\Gamma} -> with \left( \right)
% \@DDbase{D-symbol}{subscript}{superscript}[\big]{\rho}{\Gamma} -> with \bigl( \bigr)
%
% and also alternative syntax, useful for higher-level macros which have already tons of [] options:
%
% \@DDbase{D-symbol}{subscript}{superscript}`*{\rho}{\Gamma} -> with \left( \right)
% \@DDbase{D-symbol}{subscript}{superscript}`\big{\rho}{\Gamma} -> with \bigl( \bigr)
%
%
\def\@DDbase#1#2#3{%
  #1_{#2}^{#3}%
  \@DDbase@parsesize%
}
\robustify\@DDbase

\def\@DDbase@parsesize{%
  \@ifnextchar`\@DDbase@withsize\@DDbase@inner%
}

\def\@DDbase@withsize`#1{%
  \def\@tmp@arg{#1}%
  \def\@tmp@star{*}%
  \ifx\@tmp@arg\@tmp@star\relax%
    \def\tmp@cmd{\@DDbase@inner*}%
    \expandafter\tmp@cmd%
  \else%
    \def\tmp@cmd{\@DDbase@inner[#1]}%
    \expandafter\tmp@cmd%
  \fi%
}

%
% \DD{\rho}{\sigma}
% \DD*{\rho}{\sigma}
% \DD`\big{\rho}{\sigma}
% (i.e. \DD<states-spec> )
%
% \DD^{superscript}<states-spec>
% \DD_{subscript}^{superscript}<states-spec>
%
% Where <states-spec>  =  <size-spec>{\rho}{\sigma}
%
% Where optional  <size-spec>  =  "`*"  or  "`\Big"

\newcommand\DD{%
  \def\DD@tmp@sub{}%
  \def\DD@tmp@sup{}%
  \DD@%
}
\def\DD@{%
  \@ifnextchar_\DD@parsesub\DD@@%
}
\def\DD@@{%
  \@ifnextchar^\DD@parsesup\DD@@@%
}
\def\DD@@@{% sub/super-scripts have been parsed, move on to rest of command
  \@DDbase{\DDSym}{\DD@tmp@sub}{\DD@tmp@sup}%
}
\def\DD@parsesub_#1{%
  \def\DD@tmp@sub{#1}%
  \DD@% continue parsing maybe another sub or superscript
}
\def\DD@parsesup^#1{%
  \def\DD@tmp@sup{#1}%
  \DD@% continue parsing maybe another sub or superscript
}


%
% \DminF{\rho}{\sigma}
% \DminF[\epsilon]{\rho}{\sigma}
% \DminF<states-spec>
% \DminF[\epsilon]<states-spec>
%
% Where <states-spec>  =  <size-spec>{\rho}{\sigma}
%
% Where optional  <size-spec>  =  "`*"  or  "`\Big"
% 
\newcommand\DminF[1][]{%
  \@DDbase{\DDSym}{\mathrm{min,F}}{#1}%
}

%
% \Dminz{\rho}{\sigma}
% \Dminz[\epsilon]{\rho}{\sigma}
% \Dminz<states-spec>
% \Dminz[\epsilon]<states-spec>
%
% Where <states-spec>  =  <size-spec>{\rho}{\sigma}
%
% Where optional  <size-spec>  =  "`*"  or  "`\Big"
% 
\newcommand\Dminz[1][]{%
  \@DDbase{\DDSym}{\mathrm{min,0}}{#1}%
}

%
% \Dmax{\rho}{\sigma}
% \Dmax[\epsilon]{\rho}{\sigma}
% \Dmax<states-spec>
% \Dmax[\epsilon]<states-spec>
%
% Where <states-spec>  =  <size-spec>{\rho}{\sigma}
%
% Where optional  <size-spec>  =  "`*"  or  "`\Big"
% 
\newcommand\Dmax[1][]{%
  \@DDbase{\DDSym}{\mathrm{max}}{#1}%
}

%
% \Dr{\rho}{\sigma}
% \Dr[\epsilon]{\rho}{\sigma}
% \Dr<states-spec>
% \Dr[\epsilon]<states-spec>
%
% Where <states-spec>  =  <size-spec>{\rho}{\sigma}
%
% Where optional  <size-spec>  =  "`*"  or  "`\Big"
% 
\newcommand\Dr[1][]{%
  \@DDbase{\DDSym}{\mathrm{r}}{#1}%
}


%
% \DHyp{\rho}{\sigma}
% \DHyp[\eta]{\rho}{\sigma}
% \DHyp<states-spec>
% \DHyp[\eta]<states-spec>
%
% Where <states-spec>  =  <size-spec>{\rho}{\sigma}
%
% Where optional  <size-spec>  =  "`*"  or  "`\Big"
% 
\newcommand\DHyp[1][\eta]{%
  \@DDbase{\DDSym}{\mathrm{H}}{#1}%
}



% -----------------------


%
% \DC@inner{rho}{Gamma1}{Gamma2}        -->  produces (rho||Gamma1,Gamma2)
% \DC@inner*{rho}{Gamma1}{Gamma2}       -->  produces \left(rho||Gamma1,Gamma2\right)
% \DC@inner[\big]{rho}{Gamma1}{Gamma2}  -->  produces \bigl(rho||Gamma1,Gamma2\bigr)
%
% If rho starts with the token *, then adds the subscript in \DC@tmp@rhosub to rho
%
\DeclarePairedDelimiterX\DC@inner[3]{(}{)}{%
  #1\mathclose{}\,\delimsize\Vert\,\mathopen{}#2\mathclose{},\mathopen{}#3%
}


%
% Symbol to use for the coherent relative entropy
%
\newcommand\DCSym{\bar\DDSym}

%
% Designates the trivial system (uses symbol for empty set)
%
\def\emptysystem{\ensuremath{\emptyset}}


%
% Coherent Relative Entropy.
%
% USAGE:
%
%   \DCond[\epsilon]{\rho}{R}{X'}{\Gamma_R}{\Gamma_{X'}}
%   \DCond[\epsilon]{*\sigma_R\otimes\rho_{X'}}{R}{X'}{\Gamma_R}{\Gamma_{X'}}
%   \DCond[\epsilon]<size-spec>{\rho}{R}{X'}{\Gamma_R}{\Gamma_{X'}}
%   \DCond[\epsilon]<size-spec>{*\sigma_R\otimes\rho_{X'}}{R}{X'}{\Gamma_R}{\Gamma_{X'}}
%
%   with an optional <size-spec> =  "`*"  or  "`\Big"
%

\newcommand\DCond[1][]{%
  \def\DC@tmp@sup{#1}%
%\message{*********|\detokenize{#1}|*********}%
  \begingroup\mathcode`\`="0060\relax
  \DC@parsesize%
}

\def\DC@parsesize#1{%
  \gdef\DC@tmp@sizeargs{}%
  \ifstrequal{#1}{`}\DC@withsize{\endgroup\DC@rest{#1}}%
%  \@ifnextchar`\DC@withsize\DC@rest%
}

\def\DC@withsize#1{%
%\message{*********\detokenize{#1}********}%
  \def\@tmp@arg{#1}%
  \def\@tmp@star{*}%
  \ifx\@tmp@arg\@tmp@star\relax%
    \gdef\DC@tmp@sizeargs{*}%
    \endgroup%
    \expandafter\DC@rest%
  \else%
    \gdef\DC@tmp@sizeargs{[#1]}%
    \endgroup%
    \expandafter\DC@rest%
  \fi%
}

\def\DC@rest#1#2#3#4#5{% #1=rho, #2=system-in, #3=system-out, #4=Gamma_in, #5=Gamma_out
%\message{*********\detokenize{#1}|\detokenize{#2}|\detokenize{#3}|\detokenize{#4}|\detokenize{#5}|********}%
  \def\DC@tmp@rho{\DC@fmtrhosub#1\DC@ENDSTATE{#2}{#3}}%
  \DCSym_{#2\to #3}^{\DC@tmp@sup}%
  \expandafter\DC@inner\DC@tmp@sizeargs{\DC@tmp@rho}{#4}{#5}%
}

\def\DC@fmtrhosub{%
  \@ifnextchar*\DC@fmtrhosub@nosub\DC@fmtrhosub@wsub%
}
\def\DC@fmtrhosub@nosub*#1\DC@ENDSTATE#2#3{%
  #1%
}
\def\DC@fmtrhosub@wsub#1\DC@ENDSTATE#2#3{%
  \begingroup%
    \let\emptysystem\relax%
    #1_{#3#2}%
  \endgroup%
}


