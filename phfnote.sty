
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{phfnote}[2016/02/20 phfnote package]


\RequirePackage{kvoptions}




%
% internal -- execute all definitions given in list of attributes
%
\def\phfnote@internal@execattribs#1#2#3{%
  %
  % #1 = prefix to look for attributes
  % 
  % #2 = name of what #1 represents, to use in message in case attribute is not found
  %
  % #3 = list of attributes
  %
  \@for\next:=#3\do{%
    \ifcsname #1\next\endcsname%
      \csname #1\next\endcsname%
    \else%
      \PackageWarning{phfnote}{Unknown #2: '\next'. Ignoring.}
    \fi
  }
}




% ------------------------------------------------------------------------------
%     TITLE
% ------------------------------------------------------------------------------

%
% -- common note title defs --
%
\newcommand{\notetitlefont}{\sffamily\bfseries}
\newcommand{\notetitleauthorfont}{}
\newcommand{\notetitledatefont}{}


%
% common to several styles -- adjust top spacing for the title
%
\def\phfnote@title@vskiptop{-1.2cm}


\def\phfnote@title@checksetspace#1{%  #1 = title style, for the error message
  \ifdefined\singlespace\else%
    \PackageError{phfnote}{Note title style `#1' requires the `setspace' package to be
      loaded!  Please load it, or use a pkgset which loads it automatically}%
  \fi%
}

% -- STYLE: default --
\newcommand{\notetitle@style@default}{% `default' style title
  \begin{flushleft}%
    \vspace*{\phfnote@title@vskiptop}%
    \phfnote@title@checksetspace{default}%
    \begin{singlespace}%
      {\Large  {\notetitlefont \@title}}\\[4mm]%
      \hspace*{0.04\textwidth}\begin{minipage}{0.96\textwidth}{\notetitleauthorfont \@author}\end{minipage}\\[2mm]%
      \hspace*{0.04\textwidth}\begin{minipage}{0.96\textwidth}{\footnotesize%
          \notetitledatefont \@date}\end{minipage}\\[4mm]%
      \hrule%
    \end{singlespace}%
    \vspace*{3mm}%
  \end{flushleft}%
}
% -- STYLE: small --
\newcommand{\notetitle@style@small}{% `small' style title
  \begin{flushleft}%
    \vspace*{\phfnote@title@vskiptop}%
    {\notetitlefont \@title}%
    \hfill\makebox{\fontsize{9pt}{10pt}\selectfont {\notetitleauthorfont \@author}%
      \hspace*{2mm}--\hspace*{2mm}{\emph{\notetitledatefont \@date}}}%
    \vspace*{1mm}\hrule\vspace*{1mm}%
  \end{flushleft}%
}
% -- STYLE: titleonly -- [ big title only. Use paragraphs for several lines ]
\newcommand{\notetitle@style@titleonly}{% `titleonly' style title
  \begin{flushleft}%
    \vspace*{\phfnote@title@vskiptop}%
    \phfnote@title@checksetspace{titleonly}%
    \begin{singlespace}%
      \begingroup%
        \Large\notetitlefont{%
          \parindent=0pt%
          \parskip=1.5ex%
          \par  \@title\par\vspace{4mm}%
          }%
      \endgroup%
      \hrule%
    \end{singlespace}%
    \vspace*{3mm}%
  \end{flushleft}%
}
% -- STYLE: article --
\newcommand{\notetitle@style@article}{% `article' style title
  % \begingroup%
  % \newpage%
  % \global\@topnum\z@   % Prevents figures from going at top of page.
  % \null%
  \vspace*{-5em}%
  \begin{center}%
    \let \footnote \thanks%
    {\LARGE \@title \par}%
    \vskip 1.5em%
    {\large%
      \lineskip .5em%
      \begin{tabular}[t]{c}%
        \@author%
      \end{tabular}\par}%
    \vskip 0.5em%
    \@thanks%
    \vskip 1em%
    {\large \@date}%
  \end{center}%
  \par%
  \vskip 1.5em%
  % \endgroup%
}



%
% Actually perform the definitions to make \maketitle produce the title with the
% given style.
%
% #1 = style name, e.g. 'default'
%
\def\phfnote@do@notetitle#1{
  \if\relax\detokenize\expandafter{#1}\relax
    %
    % Empty definition -- leave default title
    %
  \else
    %
    % Custom note title to set.
    %
    \ifcsname notetitle@style@#1\endcsname
      \def\phfnote@tmp@titsty{#1}%
    \else
      \PackageError{phfnote}{Unknown title style: '#1'. Using default style instead}
      \def\phfnote@tmp@titsty{default}%
    \fi
    %
    % Actually overload title style
    %
    \def\@maketitle{\csname notetitle@style@\phfnote@tmp@titsty\endcsname}
  \fi
}

%
% Provide long definition for \title{}, so that several "paragraphs" can be put into the
% title as different lines.
%
\long\def\title#1{\gdef\@title{#1}}

% ------------------------------------------------------------------------------
%     ABSTRACT
% ------------------------------------------------------------------------------

\let\notedefaultabstract\abstract
\let\endnotedefaultabstract\endabstract

\newcommand{\noteabstracttextfont}{}
\newcommand{\noteabstractnamefont}{\bfseries\small}
\if@twocolumn
  \newcommand\noteabstracttextwidth{\hsize}
\else
  \newcommand{\noteabstracttextwidth}{0.9\hsize}
\fi

\def\noteabstract@nameline{
  \begin{center}{\noteabstractnamefont\abstractname}\end{center}\vspace*{-2mm}%
}

\newlength\noteabstractafterspacing
\setlength{\noteabstractafterspacing}{4mm}
\newenvironment{noteabstract}{%
  \begin{center}%
    \begin{minipage}{\noteabstracttextwidth}%
      \noteabstract@nameline%
      \noteabstracttextfont%
    }% begin commands
    {% end commands
    \end{minipage}\end{center}\vspace*{\noteabstractafterspacing}%
} % end commands


\def\noteabstract@attr@wide{%
  \def\noteabstracttextwidth{\textwidth}%
}
\def\noteabstract@attr@narrow{%
  \if@twocolumn
  \else
    \def\noteabstracttextwidth{0.8\textwidth}%
  \fi
}

\def\noteabstract@attr@noname{%
  \def\noteabstract@nameline{\vspace*{1ex}}%
}

\def\noteabstract@attr@original{%
  \let\abstract\notedefaultabstract
  \let\endabstract\endnotedefaultabstract
}

\def\noteabstract@attr@small{%
  \g@addto@macro\noteabstracttextfont{\small}%
}

\def\noteabstract@attr@it{%
  \g@addto@macro\noteabstracttextfont{\itshape}%
}


%
%  #1 = a comma-separated list of attributes
%
\def\phfnote@do@noteabstract#1{

  \let\abstract\noteabstract
  \let\endabstract\endnoteabstract

  \phfnote@internal@execattribs{noteabstract@attr@}{abstract attribute}{#1}
}


% ------------------------------------------------------------------------------
%     PAGE GEOMETRY
% ------------------------------------------------------------------------------

\def\phfnote@pagegeomstyle@default{
  \if@twocolumn
    \PassOptionsToPackage{hmargin=1in,vmargin=0.75in,includeheadfoot}{geometry}%
  \else
    % fix the margins a bit to make text wider
    \ifcase\@ptsize% mods for 10 pt
      \PassOptionsToPackage{hmargin=1.5in,vmargin=1.25in}{geometry}%
    \or% mods for 11 pt
      \PassOptionsToPackage{hmargin=1.5in,vmargin=1.25in}{geometry}%
    \or% mods for 12 pt
      \PassOptionsToPackage{hmargin=1.25in,vmargin=1.25in}{geometry}%
    \fi%
  \fi
}
\def\phfnote@pagegeomstyle@narrow{
  \if@twocolumn
    \PassOptionsToPackage{hmargin=1.25in,vmargin=0.75in,includeheadfoot}{geometry}%
  \else
    % fix the margins a bit to make text wider
    \ifcase\@ptsize% mods for 10 pt
      \PassOptionsToPackage{hmargin=1.75in,vmargin=1.5in}{geometry}%
    \or% mods for 11 pt
      \PassOptionsToPackage{hmargin=1.75in,vmargin=1.5in}{geometry}%
    \or% mods for 12 pt
      \PassOptionsToPackage{hmargin=1.5in,vmargin=1.5in}{geometry}%
    \fi%
  \fi
}
\def\phfnote@pagegeomstyle@wide{
  \if@twocolumn
    \PassOptionsToPackage{hmargin=0.75in,vmargin=0.75in,includeheadfoot}{geometry}%
  \else
    % fix the margins a bit to make text wider
    \ifcase\@ptsize% mods for 10 pt
      \PassOptionsToPackage{hmargin=1.25in,vmargin=1.25in}{geometry}%
    \or% mods for 11 pt
      \PassOptionsToPackage{hmargin=1.25in,vmargin=1.25in}{geometry}%
    \or% mods for 12 pt
      \PassOptionsToPackage{hmargin=1in,vmargin=1.25in}{geometry}%
    \fi%
  \fi
}
\def\phfnote@pagegeomstyle@xwide{
  \if@twocolumn
    \PassOptionsToPackage{hmargin=0.5in,vmargin=0.5in,includeheadfoot}{geometry}%
  \else
    % fix the margins a bit to make text wider
    \ifcase\@ptsize% mods for 10 pt
      \PassOptionsToPackage{hmargin=1in,vmargin=1.25in}{geometry}%
    \or% mods for 11 pt
      \PassOptionsToPackage{hmargin=1in,vmargin=1.25in}{geometry}%
    \or% mods for 12 pt
      \PassOptionsToPackage{hmargin=0.75in,vmargin=1.25in}{geometry}%
    \fi%
  \fi
}

\newcommand{\phfnote@do@pagegeomdefs}[1]{

  \ifcsname phfnote@pagegeomstyle@#1\endcsname
    \csname phfnote@pagegeomstyle@#1\endcsname
  \else
    \PackageWarning{phfnote}{Unknown page geometry style: `#1'!}
  \fi

  \RequirePackage{geometry}%
}



% ------------------------------------------------------------------------------
%     TEXT, PARAGRAPH, AND LINE SPACING
% ------------------------------------------------------------------------------


\def\phfnote@do@spacing{

  \@ifpackageloaded{setspace}{
    \def\phfnote@dostretch##1{\setstretch{##1}\phfnote@docaptionstretch{##1}}
  }{
    \def\phfnote@dostretch##1{\renewcommand\baselinestretch{##1}\phfnote@docaptionstretch{##1}}
  }
  \@ifpackageloaded{caption}{
    \def\phfnote@docaptionstretch##1{\captionsetup{font={stretch=##1}}}
  }{
    \def\phfnote@docaptionstretch##1{\PackageWarning{phfnote}{Can't set line spacing for
        captions, because the package `caption' is not loaded.  Please load it before
        `phfnote', or use an appropriate (e.g. `rich') pkgset which loads this package
        automatically .}}
  }

  \if@twocolumn
    \phfnote@dostretch{1.0} % leave default
    \emergencystretch=3em\relax
  \else
    \ifcase\@ptsize% 10pt
      \phfnote@dostretch{1.1}
    \or% 11pt
      \phfnote@dostretch{1.0} %1.05
    \or% 12pt
      \phfnote@dostretch{1.0} %1.03
    \fi
    \emergencystretch=6em\relax
  \fi

}

% 
% Paragraph Settings
% 
\def\phfnote@par@original{%
}
\def\phfnote@par@indent{%
  \setlength{\parindent}{1.5em}
  \setlength{\parskip}{0em} %0.3em
}
\def\phfnote@par@indentminiskip{%
  \setlength{\parindent}{1.5em}
  \setlength{\parskip}{0.3em}
}
\def\phfnote@par@skip{%
  \setlength{\parindent}{0em}
  \setlength{\parskip}{0.8em}
}

\def\phfnote@do@par#1{%
  \ifcsname phfnote@par@#1\endcsname
    \csname phfnote@par@#1\endcsname
  \else
    \PackageWarning{phfnote}{Bad paragraph setting: #1. Leaving original}
  \fi
}


% ------------------------------------------------------------------------------
%     INLINE TABLE OF CONTENTS
% ------------------------------------------------------------------------------


\newcommand{\inlinetoc}{%
  {%
    \vspace*{2mm}%
    \hrule%
    \vspace*{-2mm}%
    \parskip=2pt\relax%
    \tableofcontents{}%
    \vspace*{4mm}%
    \hrule%
    \vspace*{6mm}%
  }%
}



% ------------------------------------------------------------------------------
%     FONTS
% ------------------------------------------------------------------------------

%
% Section fonts are customized using the {sectsty} package.  If this conflicts
% in your document, use the [nosectionfonts] package option, then sectsty won't
% be loaded.
%


% Font Settings
%
% 	pbk = bookman ; bch = charter ; ppl = palatino ; ptm = Adobe Times ;
% 	phv = Adobe Helvetica ; pcr = Adobe Courier ; put = Utopia ;
% 	cmr = Comupter Modern Roman ; cmss = CM Sans Serif
%

%
\newcommand{\notesectionfontsize}{\large}
\newcommand{\notesubsectionfontsize}{\normalsize}
\newcommand{\notesubsubsectionfontsize}{\small}
\newcommand{\noteparagraphfontsize}{\normalsize}
\newcommand{\notesubparagraphfontsize}{\normalsize}
%
\newcommand{\notesectionfont}{\fontfamily{\notesectionfontfamily}\fontseries{bx}\selectfont}
\newcommand{\notesectionfontfamily}{ppl}
% 
\newcommand{\notesectionfontsetsizes}[3]{%
  \renewcommand{\notesectionfontsize}{#1}%
  \renewcommand{\notesubsectionfontsize}{#2}%
  \renewcommand{\notesubsubsectionfontsize}{#3}%
}
% 
\newcommand{\noteparagraphfontsetsizes}[2]{%
  \renewcommand{\noteparagraphfontsize}{#1}%
  \renewcommand{\notesubparagraphfontsize}{#2}%
}


\def\phfnote@do@secfmt@section{
  \sectionfont{\notesectionfont\notesectionfontsize}
  \subsectionfont{\notesectionfont\notesubsectionfontsize}
  \subsubsectionfont{\notesectionfont\notesubsubsectionfontsize}
}
\def\phfnote@do@secfmt@paragraph{
  \paragraphfont{\notesectionfont\noteparagraphfontsize}
  \subparagraphfont{\notesectionfont\notesubparagraphfontsize}
}
\def\phfnote@do@secfmt@compact{
  \notesectionfontsetsizes{\normalsize}{\small}{\small}
}
\def\phfnote@do@secfmt@sffamily{
  \renewcommand\notesectionfontfamily{\sfdefault}
}
\def\phfnote@do@secfmt#1{%
  \RequirePackage{sectsty}
  \phfnote@internal@execattribs{phfnote@do@secfmt@}{section formatting preset}{#1}
}




% ------------------------------------------------------------------------------
%     INCLUDE DEFAULT SET OF USEFUL PACKAGES
% ------------------------------------------------------------------------------

\def\phfnote@do@pkgset@none{
}

\def\phfnote@do@pkgset@minimal{

  \RequirePackage{amsmath}
  \RequirePackage{amsfonts}
  \RequirePackage{amssymb}
  \RequirePackage{amsthm}
  
  \RequirePackage{xcolor}

}

\def\phfnote@do@pkgset@rich{

  \phfnote@do@pkgset@minimal

  \RequirePackage{setspace}
  \RequirePackage{caption}

  \RequirePackage{microtype}

  \PassOptionsToPackage{shortlabels}{enumitem}
  \RequirePackage{enumitem}

  \RequirePackage{graphicx}

  \PassOptionsToPackage{T1}{fontenc}
  \RequirePackage{fontenc}

  \PassOptionsToPackage{utf8}{inputenc}
  \RequirePackage{inputenc}
}

\def\phfnote@do@pkgset@extended{

  \phfnote@do@pkgset@rich

  \RequirePackage{float}

  \RequirePackage{verbdef}

  \RequirePackage{csquotes}

  \RequirePackage{dsfont}
  \RequirePackage{bbm}
  \RequirePackage{mathtools}

}

\def\phfnote@do@pkgset#1{

  \phfnote@internal@execattribs{phfnote@do@pkgset@}{package set}{#1}
%  \ifcsname phfnote@do@pkgset@#1\endcsname
%    \csname phfnote@do@pkgset@#1\endcsname
%  \else
%    \PackageWarning{phfnote}{Unknown package set to load: #1. Loading minimal set}
%    \phfnote@do@pkgset@minimal
%  \fi

}



% ------------------------------------------------------------------------------
%     PDF & HYPERLINKS - HYPERREF
% ------------------------------------------------------------------------------


%
% NOTE: the name `docnotelinkcolor' is hard-coded in many other files I've used,
% so I'm NOT changing it.
%


%
% Set links color.  Use as \phfnotePdfLinkColor{<color specification or name>}.
%
% The pacakge {xcolor} must be loaded.
%
\newcommand{\phfnotePdfLinkColor}[1]{%
  \@ifpackageloaded{xcolor}{%
    \colorlet{docnotelinkcolor}{#1}%
  }{% else:
    \PackageWarning{phfnote}{\protect\phfnotePdfLinkColor may only be used if the package
      xcolor is loaded.}%
  }%
}

\newcommand{\phfnote@do@pdfhyperrefdefs}{%
  %
  % Make sure a color-managing package is loaded, {color} or {xcolor}
  %
  \phfnote@requirecolorpackage%
  % 
  % Define our default color
  % 
  \definecolor{docnotelinkcolor}{rgb}{0,0,0.4}% actually define our PDF hyperref link color
  % 
  %
  % Load URL package.
  %
  \RequirePackage{url}%
  %
  \DeclareUrlCommand\phfnote@format@url{}% a version of \url which is not patched by hyperref
  % 
  %
  % Set up hyperref
  %
  \PassOptionsToPackage{bookmarks=true,backref=false}{hyperref}%
  \RequirePackage{hyperref}%
  %
  \hypersetup{unicode=true,%
    bookmarksnumbered=false,bookmarksopen=false,bookmarksopenlevel=1,%
    breaklinks=true,pdfborder={0 0 0},colorlinks=true}%
  \hypersetup{%
    anchorcolor=docnotelinkcolor,citecolor=docnotelinkcolor,%
    filecolor=docnotelinkcolor,linkcolor=docnotelinkcolor,%
    menucolor=docnotelinkcolor,runcolor=docnotelinkcolor,%
    urlcolor=docnotelinkcolor}%
  %
  %
  % Provide an \email command.
  %
  \let\email\phfnote@email%
  %
  %
  % And set the default \url/\email style
  %
  \urlstyle{notesf}%
  %
}


% 
% and also provide an \email{} command for emails.
% 
\def\phfnote@sanitize@url{%
  \catcode`\$12%
  \catcode`\&12%
  \catcode`\#12%
  \catcode`\^12%
  \catcode`\_12%
  \catcode`\%12%
  % \catcode`\^^J10%  newline = space
  % \catcode`\^^M10%  newline = space
  \relax%
}%
\providecommand\phfnote@format@url{\texttt}
\def\phfnote@email{\begingroup\phfnote@sanitize@url\phfnote@impl@email@}%
\def\phfnote@impl@email@#1{\endgroup\href{mailto:#1}{\phfnote@format@url{#1}}}%
% 







\def\phfnote@requirecolorpackage{%
  % require the 'color' or 'xcolor' package
  \@ifpackageloaded{color}{%
    % all fine
  }{% else
    \@ifpackageloaded{xcolor}{%
      % all fine again
    }{% else - no color package loaded
      \RequirePackage{xcolor}%
    }%
  }%
}

% ------------------------------------------------------------------------------
%     NICE FONT DEFS
% ------------------------------------------------------------------------------

\def\phfnote@do@fontdefs{
 
  \PassOptionsToPackage{T1}{fontenc}
  \RequirePackage{fontenc}

  \renewcommand\sfdefault{cmbr}
  
}

% ------------------------------------------------------------------------------
%     BIBLIOGRAPHY
% ------------------------------------------------------------------------------

%
% our default bibliography style -- hacked version of naturemag
%
\newcommand{\phfnote@bibstyle}{naturemagdoi}

%
%
%
\newcommand{\phfnote@bibliographystyle}[1]{\renewcommand{\phfnote@bibstyle}{#1}}
\newcommand{\phfnotebibfont}{\fontsize{9}{11}\selectfont}

\let\phfnote@old@bibliography\bibliography
\let\phfnote@old@bibliographystyle\bibliographystyle

\newcommand{\phfnote@bibliography}[1]{%
  \begingroup%
    \phfnotebibfont%
    % \bibliographystyle{unsrturl}
    \phfnote@old@bibliographystyle{\phfnote@bibstyle}%
    %
    % \clearpage%
    \addcontentsline{toc}{section}{\refname}
    % 
    % Some fixes for some special chars which may appear in ill-advised
    % bibliography managers -- such as the '&' symbol
    % 
    \catcode`\&=12\relax% normal char
    %
    % Defs for appearance
    %
    \providecommand\eprint[2][]{\href{http://arxiv.org/abs/##2}{arXiv:##2}}
    %
    \phfnote@old@bibliography{#1}%
    %
  \endgroup%
}

\def\phfnote@do@bibliographydefs{%
  \let\bibliographystyle\phfnote@bibliographystyle%
  \let\bibliography\phfnote@bibliography%
}


% ------------------------------------------------------------------------------
%     FOOTNOTES
% ------------------------------------------------------------------------------

\def\phfnote@do@footnotedefs{
  \let\phfnote@orig@makefnmark\@makefnmark
%  \def\@makefnmark{\hbox{\@textsuperscript{\normalfont\tiny\fontseries{sb}\selectfont\@thefnmark}}}
  \def\@makefnmark{\hbox{\@textsuperscript{\normalfont\tiny\bfseries\@thefnmark}}}
%  \def\@makefnmark{\hbox{\@textsuperscript{\normalfont\scriptsize\bfseries\@thefnmark}}} % too large
}


% ==============================================================================

%
% OTHER, STAND-ALONE USEFUL DEFINITIONS
% 

\def\notesmallerfrac{0.9}
\newcommand\notesmaller[1][\notesmallerfrac]{%
  \fontsize{#1\dimexpr\f@size pt\relax}{#1\dimexpr\f@baselineskip pt\relax}%
  \selectfont\ignorespaces%
}

%
% URL styles: 'notett', 'notesf', 'noteitsf', 'noterm', 'noteit' and 'notesml'
%
\def\url@notettstyle{%
  \def\UrlFont{\ttfamily\notesmaller}%
  \phfnote@urlstyle@common%
}
\def\url@notesfstyle{%
  \def\UrlFont{\sffamily\notesmaller}%
  \phfnote@urlstyle@common%
}
\def\url@notesfssstyle{%
  \def\UrlFont{\fontfamily{cmss}\selectfont\notesmaller}%
  \phfnote@urlstyle@common%
}
\def\url@noteitsfstyle{%
  \def\UrlFont{\sffamily\itshape\notesmaller}%
  \phfnote@urlstyle@common%
}
\def\url@notermstyle{%
  \def\UrlFont{\rmfamily\notesmaller}%
  \phfnote@urlstyle@common%
}
\def\url@noteitstyle{%
  \def\UrlFont{\itshape\notesmaller}%
  \phfnote@urlstyle@common%
}
\def\url@notesmlstyle{%
  \def\UrlFont{\notesmaller}%
  \phfnote@urlstyle@common%
}

\def\phfnote@url@tilde{\hbox{\fontfamily{ptm}\selectfont\textasciitilde}}
\def\phfnote@urlstyle@common{%
%  \def\UrlTildeSpecial{\do\~{\raise-0.8ex\hbox{\kern-0.2ex\fontfamily{cmbr}\selectfont\textasciitilde}}}
  % \raise-0.8ex\hbox{\kern-0.2ex\textasciitilde}}}%
  \def\UrlTildeSpecial{\do\~{\phfnote@url@tilde}}%
  \let\Url@force@Tilde\UrlTildeSpecial%
}

%
% Fix \path and \email commands to follow \urlstyle
%
\def\noteUrlFixCommands{%
%  \DeclareUrlCommand\path{}
%  \DeclareUrlCommand\email{}
}



% ==============================================================================
% DEFINE PACKAGE OPTIONS
% ==============================================================================


\SetupKeyvalOptions{
  family=phfnote,
  prefix=phfnote@opt@
}

%
% e.g. [pkgset=minimal]
%
% Package set to load, for convenience.  'none', 'minimal', 'rich', or 'extended'
%
\DeclareStringOption[rich]{pkgset}


%
% e.g. [title=small]
%
% The title style to use. By default, the 'default' style.  May be 'default', 'small', or
% 'article'.  You may leave empty to avoid overriding the title style, and leaving the
% class default.
%
\DeclareStringOption[default]{title}

%
% e.g. [pagegeomdefs=false]
%
% Define the page geometry.  This tries to come up with nice margin widths
% depending on note font size (10pt,11pt,12pt) and whether it is [twocolumn] or
% not.
%
% [nopagegeomdefs] is equivalent to [pagegeomdefs=false]
%
\DeclareBoolOption[true]{pagegeomdefs}
\DeclareComplementaryOption{nopagegeomdefs}{pagegeomdefs}

%
% e.g. [pagegeom=narrow]
%
% The style of page geometry to use.  Available are 'narrow', 'default', 'wide' and
% 'xwide'
%
% This has no effect if [pagegeomdefs=false] was given.
%
\DeclareStringOption[default]{pagegeom}

%
% e.g. [spacingdefs=false]
%
% Add definitions to adjust spacing of lines and words.  Includes definitions to
% avoid overflowing words in the margin in case of long words.
%
% [nospacingdefs] is equivalent to [spacingdefs=false]
%
\DeclareBoolOption[true]{spacingdefs}
\DeclareComplementaryOption{nospacingdefs}{spacingdefs}


%
% e.g. [par=skip] or [par=indent]
%
% How to treat paragraphs.  Can be indented ('indent'), with an empty line ('skip'),
% indented with small skip ('indentminiskip') or no change from LaTeX default
% ('original').
%
\DeclareStringOption[skip]{par}


%
% e.g. [abstract={noname,narrow}]
%
% Abstract flags.  May be a comma-separated list of the following: 'wide',
% 'narrow', 'noname', 'small', 'it', 'original'
%
\DeclareStringOption[]{abstract}

%
% e.g. [hyperrefdefs=false]
%
% Load hyperref and corresponding definitions.
%
\DeclareBoolOption[true]{hyperrefdefs}
%
% [nohyperrefdefs] is equivalent to [hyperrefdefs=false]
%
\DeclareComplementaryOption{nohyperrefdefs}{hyperrefdefs}


%
% e.g. [fontdefs=true]
%
% Do some adjustments to the fonts. In particular, use the Computer Modern Bright sans
% serif font instead of the default sans serif font, e.g. for the title.
%
\DeclareBoolOption[true]{fontdefs}
%
% [nofontdefs] is equivalent to [fontdefs=false]
%
\DeclareComplementaryOption{nofontdefs}{fontdefs}

%
% e.g. [secfmt={section,compact}]
%
% Styling of section headings.  Value is comma-separated list of actions to
% take, chosen among:
%
%  - "section"  style section/subsection/subsubsection headings
%
%  - "compact"  make section/subsection/subsubsection headings more compact. Needs to be
%    used in conjunction with 'section'
%
%  - "paragraph"  style paragraph/subparagraph headings
%
% Leave empty to keep the original styling.
%
\DeclareStringOption[section]{secfmt}

%
% e.g. [footnotedefs=false]
%
% Adjustments for footnotes. Changes the symbol appearance a little bit.
%
\DeclareBoolOption[true]{footnotedefs}
%
% [nofootnotedefs] is equivalent to [footnotedefs=false]
%
\DeclareComplementaryOption{nofootnotedefs}{footnotedefs}

%
% e.g. [bibliographydefs=false]
%
% Adjustments for bibliography, including default style
%
\DeclareBoolOption[true]{bibliographydefs}
%
% [nobibliographydefs] is equivalent to [bibliographydefs=false]
%
\DeclareComplementaryOption{nobibliographydefs}{bibliographydefs}



% ----------------------------
%          PRESETS
% ----------------------------

%
% A hook for presets to do stuff at the end of package load.
%

\def\phfnote@hook@atendload{}

%
% DEFINE PRESETS
% --------------------
%
\def\phfnote@preset@article{
  \def\phfnote@opt@title{article}
  \def\phfnote@opt@par{indent}
  \def\phfnote@opt@pagegeom{default}
}
% -------------
\newcommand\phfnote@presetcommon@xnote[1][noteitsf]{% common settings to all "{sf|sfss|utopia}note" presets
  \def\phfnote@opt@title{default}
  \def\phfnote@opt@par{skip}
  \def\phfnote@opt@pagegeom{wide}
  \g@addto@macro\phfnote@hook@atendload{
    \ifdefined\urlstyle
      \urlstyle{#1}
    \fi
  }
}
\def\phfnote@preset@sfnote{
  \phfnote@presetcommon@xnote
  \phfnote@opt@footnotedefstrue
  \phfnote@opt@fontdefstrue
  \renewcommand\familydefault{\sfdefault}
  \renewcommand{\notesectionfontfamily}{\sfdefault}
}
\def\phfnote@preset@sfssnote{
  % as sfnote, ...
  \phfnote@preset@sfnote
  % ... but:
  \phfnote@opt@fontdefsfalse
  \PassOptionsToPackage{T1}{fontenc}
  \RequirePackage{fontenc}
  \renewcommand\sfdefault{cmss}
}
\def\phfnote@preset@utopianote{
  \phfnote@presetcommon@xnote[noteit]
  \phfnote@opt@fontdefsfalse
  \PassOptionsToPackage{T1}{fontenc}
  \RequirePackage{fontenc}
  \RequirePackage{fourier}
  \renewcommand{\notesectionfontfamily}{put}
  \renewcommand{\notetitlefont}{\bfseries}
  \renewcommand{\sfdefault}{phv}
}
\def\phfnote@preset@mnmynote{
  \phfnote@presetcommon@xnote[noteit]
  \phfnote@opt@footnotedefsfalse
  \phfnote@opt@fontdefsfalse
  \PassOptionsToPackage{T1}{fontenc}
  \RequirePackage{fontenc}
  \renewcommand{\notesectionfontfamily}{\sfdefault}
  % require these AFTER the default package set, because some symbols may be defined in package sets etc...
  \g@addto@macro\phfnote@hook@atendload{
    \RequirePackage{MnSymbol}
    \PassOptionsToPackage{medfamily,textosf,mathlf,minionint,footnotefigures}{MinionPro}
    \RequirePackage{MinionPro}
    \PassOptionsToPackage{medfamily}{MyriadPro}
    \RequirePackage{MyriadPro}
  }
}
\def\phfnote@preset@reset{
  \def\phfnote@opt@pkgset{none}
  \def\phfnote@opt@title{}
  \phfnote@opt@pagegeomdefsfalse
  \phfnote@opt@spacingdefsfalse
  \def\phfnote@opt@par{original}
  \def\phfnote@opt@abstract{original}
  \phfnote@opt@hyperrefdefsfalse
  \phfnote@opt@fontdefsfalse
  \def\phfnote@opt@secfmt{}
  \phfnote@opt@bibliographydefsfalse
  \phfnote@opt@footnotedefsfalse
% ADD RESET DEF HERE for new options.
}


%
% Allow to set a preset, which may set other options, for example.
%
\define@key{phfnote}{preset}{%
  \ifcsname phfnote@preset@#1\endcsname%
    \csname phfnote@preset@#1\endcsname%
  \else%
    \PackageWarning{phfnote}{Unknown preset: `#1'!}
  \fi%
}



%
% NOW PROCESS THE OPTIONS
%

\DeclareDefaultOption{%
  % We provide the standard LaTeX error.
  \@unknownoptionerror
}

\ProcessKeyvalOptions*


% ==============================================================================
% EXECUTE PACKAGE OPTIONS
% ==============================================================================



%
% execute definitions controlled by options
%


\phfnote@do@pkgset{\phfnote@opt@pkgset}

\phfnote@do@notetitle{\phfnote@opt@title}

\phfnote@do@noteabstract{\phfnote@opt@abstract}

\phfnote@do@secfmt{\phfnote@opt@secfmt}

\ifphfnote@opt@pagegeomdefs
  \phfnote@do@pagegeomdefs{\phfnote@opt@pagegeom}
\fi

\ifphfnote@opt@spacingdefs
  \phfnote@do@spacing
\fi

\phfnote@do@par{\phfnote@opt@par}

\ifphfnote@opt@hyperrefdefs
  \phfnote@do@pdfhyperrefdefs
\fi

\ifphfnote@opt@fontdefs
  \phfnote@do@fontdefs
\fi

\ifphfnote@opt@bibliographydefs
  \phfnote@do@bibliographydefs
\fi

\ifphfnote@opt@footnotedefs
  \phfnote@do@footnotedefs
\fi



\phfnote@hook@atendload


